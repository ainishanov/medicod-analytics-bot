# üìä –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQLite –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

## –û–±–∑–æ—Ä

–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –±–æ—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç **—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö** –∏–∑ SQLite –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–æ–≥–æ–≤!

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

- ‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å**: –î–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–æ –ª–æ–≥–æ–≤
- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å**: –ë—ã—Å—Ç—Ä—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã –≤–º–µ—Å—Ç–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞
- ‚úÖ **–ü–æ–ª–Ω–æ—Ç–∞**: –í—Å—è –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ **Fallback**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –Ω–∞ mock –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd Medicod_Analytics_Bot
npm install
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

```bash
npm run test:db
# –∏–ª–∏
node src/testDatabase.js
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
üìä –¢–µ—Å—Ç 1: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
- –í—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π: 79
- –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: 3291‚ÇΩ
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: 42‚ÇΩ
```

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:

- `src/database.js` - –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQLite (read-only)
- `src/testDatabase.js` - –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- `DATABASE_INTEGRATION.md` - –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

- `src/analyticsService.js` - –û–±–Ω–æ–≤–ª—ë–Ω `analyzePayments()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ë–î
- `package.json` - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `better-sqlite3`

---

## üóÑÔ∏è –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –õ–æ–∫–∞–ª—å–Ω–æ (Windows/Mac):
```
Medicod_Backend/data/medicod.db
```

### –ù–∞ production (Linux):
```
/root/medicod/Medicod_Backend/data/medicod.db
```

### –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏:
```bash
# –í .env —Ñ–∞–π–ª–µ
DATABASE_PATH=/custom/path/to/medicod.db
```

---

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```javascript
import { getDatabaseInstance } from './database.js';

const db = getDatabaseInstance();

if (db && db.isAvailable()) {
  console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞');
} else {
  console.log('‚ö†Ô∏è  Fallback –Ω–∞ mock –¥–∞–Ω–Ω—ã–µ');
}
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥:
```javascript
const stats = db.getPaymentStats({
  dateFrom: new Date('2025-11-01').toISOString()
});

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
// { total_count: 137, total_revenue: 4783, avg_amount: 35, ... }
```

#### –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –¥–Ω—è–º:
```javascript
const dailyStats = db.getDailyStats({
  dateFrom: new Date('2025-11-01').toISOString()
});

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
// [
//   { date: '2025-11-04', count: 14, revenue: 686, ... },
//   { date: '2025-11-03', count: 5, revenue: 245, ... }
// ]
```

#### –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π:
```javascript
const payments = db.getPayments({
  limit: 10,
  dateFrom: new Date('2025-11-01').toISOString()
});
```

---

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Fallback

–ë–æ—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:

| –ò—Å—Ç–æ—á–Ω–∏–∫ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
|----------|-----------|-------------------|
| **SQLite –ë–î** | 1 (–≤—ã—Å—à–∏–π) | –ï—Å–ª–∏ –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞ |
| **–õ–æ–≥–∏ systemd** | 2 | –ï—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏ —ç—Ç–æ Linux |
| **Mock –¥–∞–Ω–Ω—ã–µ** | 3 (–Ω–∏–∑—à–∏–π) | –ï—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏ —ç—Ç–æ Windows |

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∏–∫–∏:

```javascript
async analyzePayments(since = '7 days ago') {
  // –ü—ã—Ç–∞–µ–º—Å—è –ë–î
  if (this.db && this.db.isAvailable()) {
    return await this.analyzePaymentsFromDB(since);
  }

  // Fallback –Ω–∞ –ª–æ–≥–∏/mock
  if (this.isWindows) {
    return this.getMockData(since);
  } else {
    return this.parseLogsForPayments(since);
  }
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ë–î:

```bash
node src/testDatabase.js
```

### –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –æ—Ç—á—ë—Ç–∞:

```bash
npm run test
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞ –≤ Telegram:

```bash
npm run send-report
```

---

## üöÄ –î–µ–ø–ª–æ–π –Ω–∞ production

### 1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ë–î –Ω–∞ —Å–µ—Ä–≤–µ—Ä

```bash
scp -r Medicod_Backend/data root@89.223.126.35:/root/medicod/Medicod_Backend/
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å analytics bot

```bash
ssh root@89.223.126.35

cd /root/medicod/Medicod_Analytics_Bot
git pull
npm install
pm2 restart medicod-analytics-bot
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
pm2 logs medicod-analytics-bot
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ SQLite –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞: /root/medicod/Medicod_Backend/data/medicod.db
```

---

## üìà –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç (—Å –ë–î):

```
üìä –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç Medicod Backend
5 –Ω–æ—è–±—Ä—è 2025 –≥.

üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚Ä¢ –ü–ª–∞—Ç–µ–∂–µ–π: 79 (+12% WoW) üìà
‚Ä¢ –í—ã—Ä—É—á–∫–∞: 3291‚ÇΩ (+8% WoW) üìà
‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: 42‚ÇΩ (+3% WoW) üìà

üìÖ –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º
‚Ä¢ Nov 04: 14 –ø–ª–∞—Ç–µ–∂–µ–π, 686‚ÇΩ
‚Ä¢ Nov 03: 5 –ø–ª–∞—Ç–µ–∂–µ–π, 245‚ÇΩ
‚Ä¢ Nov 02: 5 –ø–ª–∞—Ç–µ–∂–µ–π, 215‚ÇΩ
```

---

## ‚ö†Ô∏è Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: C:\...\medicod.db
‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è mock/–ª–æ–≥–∏
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ë–î —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `Medicod_Backend/data/medicod.db`
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:
   ```bash
   cd Medicod_Backend
   node src/scripts/syncPayments.js --days=90
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ë–î

**–°–∏–º–ø—Ç–æ–º—ã:**
```
SqliteError: unable to open database file
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:
   ```bash
   chmod 644 Medicod_Backend/data/medicod.db
   ```
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ë–î –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç—á—ë—Ç–µ

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚Ä¢ –ü–ª–∞—Ç–µ–∂–µ–π: 0
‚Ä¢ –í—ã—Ä—É—á–∫–∞: 0‚ÇΩ
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤ –ë–î –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ:
   ```bash
   node src/testDatabase.js
   ```
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –∑–∞–ø—Ä–æ—Å–∞

---

## üéØ Roadmap

- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQLite –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- [x] Fallback –Ω–∞ –ª–æ–≥–∏ –∏ mock –¥–∞–Ω–Ω—ã–µ
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- [ ] –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ Telegram
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤ –≤ PDF/Excel

---

## üìù Changelog

### v2.1.0 (2025-11-05)

**‚ú® –î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQLite –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–¥—É–ª—å `database.js` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (read-only)
- –ú–µ—Ç–æ–¥ `analyzePaymentsFromDB()` –≤ AnalyticsService
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –ª–æ–≥–∏/mock –¥–∞–Ω–Ω—ã–µ
- –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è `testDatabase.js`

**üîß –ò–∑–º–µ–Ω–µ–Ω–æ:**
- `analyzePayments()` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ë–î –≤–º–µ—Å—Ç–æ –ª–æ–≥–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `better-sqlite3 ^11.10.0`

**üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –¢–æ—á–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: 100% (–∏–∑ –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫–∞)
- –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤: ~10ms (vs ~500ms –ø–∞—Ä—Å–∏–Ω–≥ –ª–æ–≥–æ–≤)
- –ò—Å—Ç–æ—Ä–∏—è: –ø–æ–ª–Ω–∞—è —Å –º–æ–º–µ–Ω—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
